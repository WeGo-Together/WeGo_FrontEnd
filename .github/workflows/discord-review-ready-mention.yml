name: Discord PR Review Ready Mention

on:
  pull_request:
    types: [labeled]

jobs:
  notify:
    if: github.event.label.name == 'Ready For Review!'
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          script: |
            const discordIdMap = {
              'Chiman2937': '472760360932474921',
              'HopeFullee': '215837654808264704',
              'claudia99503': '1196405542751571979',
              'yoorli': '1252243063066067057',
              'wooktori': '410687167329992714'
            };

            // PRì— ì§€ì •ëœ ë¦¬ë·°ì–´ë“¤ì˜ GitHub username ì¶”ì¶œ
            const reviewers = context.payload.pull_request.requested_reviewers?.map(
              reviewer => reviewer.login
            ) || [];

            // Discord ë©˜ì…˜ ìƒì„±
            const mentions = reviewers
              .map(username => {
                const discordId = discordIdMap[username];
                return discordId ? `<@${discordId}>` : null;
              })
              .filter(mention => mention !== null)
              .join(' ');

            const message = mentions || '@here';

            // PR ë³¸ë¬¸ì—ì„œ ì—°ê²°ëœ ì´ìŠˆ ì¶”ì¶œ (ì˜ˆ: #123, Closes #123, Fixes #123 ë“±)
            const prBody = context.payload.pull_request.body || '';
            const issueMatches = prBody.match(/#(\d+)/g);
            const linkedIssues = issueMatches 
              ? issueMatches.map(match => `[${match}](${context.payload.repository.html_url}/issues/${match.slice(1)})`).join(', ')
              : 'ì—°ê²°ëœ ì´ìŠˆ ì—†ìŒ';

            // Discord ì›¹í›… ì „ì†¡
            const payload = {
              content: `${message} PR ë¦¬ë·° ë°›ì„ ì¤€ë¹„ê°€ ì™„ë£Œëì–´ìš”! ğŸš€`,
              embeds: [{
                title: `#${context.payload.pull_request.number} ${context.payload.pull_request.title}`,
                url: context.payload.pull_request.html_url,
                description: `ğŸ”— **ì—°ê²°ëœ ì´ìŠˆ**: ${linkedIssues}`,
                color: 5763719,  // ìƒ‰ìƒ (hexë¥¼ decimalë¡œ: #57F287 = ì´ˆë¡)
                thumbnail: {
                  url: context.payload.pull_request.user.avatar_url  // ì‘ì„±ì í”„ë¡œí•„ ì´ë¯¸ì§€
                },
                fields: [
                  {
                    name: 'ğŸ‘¤ ì‘ì„±ì',
                    value: context.payload.pull_request.user.login,
                    inline: true
                  },
                  {
                    name: 'ğŸŒ¿ ë¸Œëœì¹˜',
                    value: `\`${context.payload.pull_request.head.ref}\``,
                    inline: true
                  },
                  {
                    name: 'ğŸ“Š ë³€ê²½ì‚¬í•­',
                    value: `+${context.payload.pull_request.additions} -${context.payload.pull_request.deletions}`,
                    inline: true
                  }
                ],
                footer: {
                  text: 'WeGo PR Review System',
                  icon_url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png'
                },
                timestamp: new Date().toISOString()
              }]
            };

            await fetch(process.env.DISCORD_WEBHOOK, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
