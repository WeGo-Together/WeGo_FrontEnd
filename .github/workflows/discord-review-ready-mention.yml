name: Discord PR Review Ready Mention

on:
  pull_request:
    types: [labeled]

jobs:
  notify:
    if: github.event.label.name == 'Ready For Review!'
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        with:
          script: |
            const discordIdMap = {
              'Chiman2937': '472760360932474921',
            };

            // í…ŒìŠ¤íŠ¸: ë³¸ì¸ì—ê²Œë§Œ ë©˜ì…˜
            const assignees = ['Chiman2937'];

            // Discord ë©˜ì…˜ ìƒì„±
            const mentions = assignees
              .map(username => {
                const discordId = discordIdMap[username];
                return discordId ? `<@${discordId}>` : null;
              })
              .filter(mention => mention !== null)
              .join(' ');

            const message = mentions || '@here';

            // Discord ì›¹í›… ì „ì†¡
            const payload = {
              content: `${message} PR ë¦¬ë·° ë°›ì„ ì¤€ë¹„ê°€ ì™„ë£Œëì–´ìš”! ğŸš€`,
              embeds: [{
                title: `ğŸ“ ${context.payload.pull_request.title}`,
                url: context.payload.pull_request.html_url,
                description: context.payload.pull_request.body?.substring(0, 200) || 'PR ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.',
                color: 5763719,  // ìƒ‰ìƒ (hexë¥¼ decimalë¡œ: #57F287 = ì´ˆë¡)
                thumbnail: {
                  url: context.payload.pull_request.user.avatar_url  // ì‘ì„±ì í”„ë¡œí•„ ì´ë¯¸ì§€
                },
                fields: [
                  {
                    name: 'ğŸ‘¤ ì‘ì„±ì',
                    value: context.payload.pull_request.user.login,
                    inline: true
                  },
                  {
                    name: 'ğŸŒ¿ ë¸Œëœì¹˜',
                    value: `\`${context.payload.pull_request.head.ref}\``,
                    inline: true
                  },
                  {
                    name: 'ğŸ“Š ë³€ê²½ì‚¬í•­',
                    value: `+${context.payload.pull_request.additions} -${context.payload.pull_request.deletions}`,
                    inline: true
                  }
                ],
                footer: {
                  text: 'WeGo PR Review System',
                  icon_url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png'
                },
                timestamp: new Date().toISOString()
              }]
            };

            await fetch(process.env.DISCORD_WEBHOOK, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
