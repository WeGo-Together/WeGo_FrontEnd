name: Discord PR Review Ready Mention

on:
  pull_request:
    types: [labeled]

jobs:
  notify:
    if: github.event.label.name == 'Ready For Review!'
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_ID_MAP: ${{ secrets.DISCORD_ID_MAP }}
        with:
          script: |
            // PR ìƒì„±í•œ ìœ ì €ì˜ ë””ìŠ¤ì½”ë“œID ì¶”ì¶œ
            const discordIdMap = JSON.parse(process.env.DISCORD_ID_MAP);
            const githubUser = '${{ github.event.pull_request.user.login }}';
            const myDiscordId = discordIdMap[githubUser];

            // discordIdMapì— ë“±ë¡ëœ ëª¨ë“  ìœ ì €ì˜ Github username ì¶”ì¶œ
            const everyone = Object.keys(discordIdMap) || [];

            // PRì— ì§€ì •ëœ ë¦¬ë·°ì–´ë“¤ì˜ GitHub username ì¶”ì¶œ
            const reviewers = context.payload.pull_request.requested_reviewers?.map(
              reviewer => reviewer.login
            ) || [];

            // Discord ë©˜ì…˜ ìƒì„± (ëª¨ë‘ì—ê²Œ)
            const mentions = Object.values(discordIdMap)
              .map(discordId => `<@${discordId}>`)
              .join(' ');

            // ë‹´ë‹¹ ë¦¬ë·°ì–´ í…ìŠ¤íŠ¸ ìƒì„±
            const reviewerText = reviewers.length > 0 
              ? reviewers.map(username => `@${username}`).join(', ')
              : 'ì§€ì •ë˜ì§€ ì•ŠìŒ';

            // PR ë³¸ë¬¸ì—ì„œ ì—°ê²°ëœ ì´ìŠˆ ì¶”ì¶œ (ì˜ˆ: #123, Closes #123, Fixes #123 ë“±)
            const prBody = github.context.payload.pull_request.body || '';
            const issueMatches = prBody.match(/#(\d+)/g);
            const linkedIssues = issueMatches 
              ? issueMatches.map(match => `[${match}](${github.context.payload.repository.html_url}/issues/${match.slice(1)})`).join(', ')
              : 'ì—°ê²°ëœ ì´ìŠˆ ì—†ìŒ';

            // Discord ì›¹í›… ì „ì†¡
            const payload = {
              content: `${mentions} PR ë¦¬ë·° ë°›ì„ ì¤€ë¹„ê°€ ì™„ë£Œëì–´ìš”! ğŸš€`,
              embeds: [{
                title: `#${github.context.payload.pull_request.number} ${github.context.payload.pull_request.title}`,
                url: github.context.payload.pull_request.html_url,
                description: `ğŸ”— **ì—°ê²°ëœ ì´ìŠˆ**: ${linkedIssues}\nğŸ‘¥ **ë‹´ë‹¹ ë¦¬ë·°ì–´**: ${reviewerText}`,
                color: 5763719,  // ìƒ‰ìƒ (hexë¥¼ decimalë¡œ: #57F287 = ì´ˆë¡)
                thumbnail: {
                  url: github.context.payload.pull_request.user.avatar_url  // ì‘ì„±ì í”„ë¡œí•„ ì´ë¯¸ì§€
                },
                fields: [
                  {
                    name: 'ğŸ‘¤ ì‘ì„±ì',
                    value: github.context.payload.pull_request.user.login,
                    inline: true
                  },
                  {
                    name: 'ğŸŒ¿ ë¸Œëœì¹˜',
                    value: `\`${github.context.payload.pull_request.head.ref}\``,
                    inline: true
                  },
                  {
                    name: 'ğŸ“Š ë³€ê²½ì‚¬í•­',
                    value: `+${github.context.payload.pull_request.additions} -${github.context.payload.pull_request.deletions}`,
                    inline: true
                  }
                ],
                footer: {
                  text: 'WeGo PR Review System',
                  icon_url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png'
                },
                timestamp: new Date().toISOString()
              }]
            };

            await fetch(process.env.DISCORD_WEBHOOK, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
