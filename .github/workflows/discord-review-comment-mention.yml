name: Discord PR Review Notification

on:
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest
    # approved ë˜ëŠ” changes_requestedë§Œ ì²˜ë¦¬
    if: |
      github.event.review.state == 'approved' || 
      github.event.review.state == 'changes_requested'
    steps:
      - name: Send Discord notification
        uses: actions/github-script@v7
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_ID_MAP: ${{ secrets.DISCORD_ID_MAP }}
        with:
          script: |
            const core = require('@actions/core');
            const discordIdMap = JSON.parse(process.env.DISCORD_ID_MAP);

            const prAuthor = context.payload.pull_request.user.login;
            const reviewer = context.payload.review.user.login;
            const reviewState = context.payload.review.state;
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const reviewUrl = context.payload.review.html_url;

            // ë¦¬ë·° ìƒíƒœì— ë”°ë¥¸ ë©”ì‹œì§€
            const statusEmoji = reviewState === 'approved' ? 'âœ…' : 'ğŸ”„';
            const statusText = reviewState === 'approved' ? 'ìŠ¹ì¸' : 'ë³€ê²½ ìš”ì²­';
            const color = reviewState === 'approved' ? 5763719 : 15158332;

            const authorDiscordId = discordIdMap[prAuthor];
            const mention = authorDiscordId ? `<@${authorDiscordId}>` : '@here';
            const content = authorDiscordId
              ? `${mention} **${reviewer}**ë‹˜ì´ [PR #${prNumber}: ${prTitle}](${reviewUrl})ì„ ${statusEmoji} **${statusText}**í–ˆìŠµë‹ˆë‹¤.`
              : `**${reviewer}**ë‹˜ì´ [PR #${prNumber}: ${prTitle}](${reviewUrl})ì„ ${statusEmoji} **${statusText}**í–ˆìŠµë‹ˆë‹¤.`;

            const payload = {
              content: content,
              embeds: [{
                color: color,
                title: `PR #${prNumber}: ${prTitle}`,
                url: reviewUrl,
                fields: [
                  {
                    name: 'ë¦¬ë·°ì–´',
                    value: reviewer,
                    inline: true
                  },
                  {
                    name: 'ìƒíƒœ',
                    value: statusText,
                    inline: true
                  }
                ]
              }]
            };

            await fetch(process.env.DISCORD_WEBHOOK, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            }).then(res => {
              if (!res.ok) {
                throw new Error(`Discord API error: ${res.status} ${res.statusText}`);
              }
            }).catch(err => {
              core.setFailed(`Failed to send Discord notification: ${err.message}`);
            });
