name: Discord PR Merged Notification

on:
  pull_request:
    types: [closed]

permissions:
  contents: read
  pull-requests: read

jobs:
  notify:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Send Discord notification
        uses: actions/github-script@v8
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_ID_MAP: ${{ secrets.DISCORD_ID_MAP }}
        with:
          script: |
            // PR ìƒì„±ìì™€ ë¨¸ì§€í•œ ì‚¬ëŒì˜ ë””ìŠ¤ì½”ë“œ ID ì¶”ì¶œ
            const discordIdMap = JSON.parse(process.env.DISCORD_ID_MAP);
            const prAuthor = '${{ github.event.pull_request.user.login }}';
            const mergedBy = '${{ github.event.pull_request.merged_by.login }}';

            // Discord ë©˜ì…˜ ìƒì„± (ëª¨ë‘ì—ê²Œ)
            const mentions = Object.values(discordIdMap)
              .map(discordId => `<@${discordId}>`)
              .join(' ');

            // PR ë³¸ë¬¸ì—ì„œ ì—°ê²°ëœ ì´ìŠˆ ì¶”ì¶œ
            const prBody = context.payload.pull_request.body || '';
            const issueMatches = prBody.match(/#(\d+)/g);
            const linkedIssues = issueMatches 
              ? issueMatches.map(match => `[${match}](${context.payload.repository.html_url}/issues/${match.slice(1)})`).join(', ')
              : 'ì—°ê²°ëœ ì´ìŠˆ ì—†ìŒ';

            // ë¦¬ë·°ì–´ ëª©ë¡ ì¶”ì¶œ
            const reviewers = context.payload.pull_request.requested_reviewers?.map(
              reviewer => reviewer.login
            ) || [];
            const reviewerText = reviewers.length > 0 
              ? reviewers.map(username => `@${username}`).join(', ')
              : 'ì§€ì •ë˜ì§€ ì•ŠìŒ';

            // Discord ì›¹í›… ì „ì†¡
            const payload = {
              content: `${mentions}\n\nPRì´ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰`,
              embeds: [{
                title: `#${context.payload.pull_request.number} ${context.payload.pull_request.title}`,
                url: context.payload.pull_request.html_url,
                description: `ğŸ”— **ì—°ê²°ëœ ì´ìŠˆ**: ${linkedIssues}\nğŸ‘¥ **ë¦¬ë·°ì–´**: ${reviewerText}`,
                color: 8311585,  // ë³´ë¼ìƒ‰ (hexë¥¼ decimalë¡œ: #7E57C1)
                thumbnail: {
                  url: context.payload.pull_request.user.avatar_url
                },
                fields: [
                  {
                    name: 'âœï¸ ì‘ì„±ì',
                    value: prAuthor,
                    inline: true
                  },
                  {
                    name: 'ğŸ”€ ë¨¸ì§€í•œ ì‚¬ëŒ',
                    value: mergedBy,
                    inline: true
                  },
                  {
                    name: 'ğŸŒ¿ ë¸Œëœì¹˜',
                    value: `\`${context.payload.pull_request.head.ref}\` â†’ \`${context.payload.pull_request.base.ref}\``,
                    inline: false
                  },
                ],
                footer: {
                  text: 'WeGo PR Review System',
                  icon_url: 'https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png'
                },
                timestamp: new Date().toISOString()
              }]
            };

            await fetch(process.env.DISCORD_WEBHOOK, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(payload)
            });
